machine:
  php:
    version: 7.0.16
compile:
  override:
    - echo "Compiling.."
dependencies:
  pre:
    - wget https://releases.hashicorp.com/terraform/0.9.2/terraform_0.9.2_linux_amd64.zip
    - unzip terraform_0.9.2_linux_amd64.zip
    - ./terraform --version
test:
  pre:
    - git clone git@github.com:artrunde/terraform-infrastructure.git --branch master
    - ./terraform output -state=terraform-infrastructure/dev/services/rodin/custom-domain-mapping/terraform.tfstate lambda_active
    - ./terraform output -state=terraform-infrastructure/dev/services/rodin/custom-domain-mapping/terraform.tfstate lambda_staging
    - ./terraform output -state=terraform-infrastructure/dev/services/osman/terraform.tfstate auto_deploy_bucket_name
    - ./terraform output -state=terraform-infrastructure/prd/services/rodin/custom-domain-mapping/terraform.tfstate lambda_active
    - ./terraform output -state=terraform-infrastructure/prd/services/rodin/custom-domain-mapping/terraform.tfstate lambda_staging
    - ./terraform output -state=terraform-infrastructure/prd/services/osman/terraform.tfstate auto_deploy_bucket_name
deployment:
  production:
    branch: master
    commands:
      - echo "No production system ready yet..."
  development:
    branch: development
    commands:
      - zip -r $(./terraform output -state=terraform-infrastructure/dev/services/rodin/custom-domain-mapping/terraform.tfstate lambda_active).zip *
      - aws cp $(./terraform output -state=terraform-infrastructure/dev/services/rodin/custom-domain-mapping/terraform.tfstate lambda_active).zip s3://$(./terraform output -state=terraform-infrastructure/dev/services/osman/terraform.tfstate auto_deploy_bucket_name)/$(./terraform output -state=terraform-infrastructure/dev/services/rodin/custom-domain-mapping/terraform.tfstate lambda_active).zip